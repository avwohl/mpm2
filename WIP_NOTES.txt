WIP: MP/M II Boot Progress
===========================

Session: 2025-12-23 - Upstream Review
-------------------------------------
Reviewed changes in cpmemu and romwbw_emu projects for shared infrastructure.

CPMEMU QKZZ80 CHANGES (commits since last mpm2 update):
- cee9c5b: Allow implementing Z80 I/O
- 70940aa: Add virtual port_in/port_out methods for I/O extensibility
- 7772f22: Add virtual halt method for subclass extensibility
- 49398c3: Make halt and bad opcode subclassable
- eacab1e: Wrap .h files in ifdefs

KEY NEW VIRTUAL METHODS in qkz80:
  virtual void port_out(qkz80_uint8 port, qkz80_uint8 value);
  virtual qkz80_uint8 port_in(qkz80_uint8 port);
  virtual void halt(void);
  virtual void unimplemented_opcode(qkz80_uint8 opcode, qkz80_uint16 pc);

ROMWBW_EMU CHANGES (major restructure):
- 246be40: Remove PC-based HBIOS dispatch, use port-only dispatch
- 2b6c7e9: Refactor CLI to use shared hbios_cpu for port I/O
- ab2d8b5: Partial restructure to move shared code between all versions
- cb2e388: Fix CP/M 3 and MP/M 2 banked mode boot

NEW SHARED FILES in romwbw_emu:
- hbios_cpu.h/cc - CPU subclass with HBIOS port I/O handling
- hbios_dispatch.h/cc - Comprehensive HBIOS function dispatch (~500 lines)
- romwbw_mem.h - Banked memory (512KB ROM + 512KB RAM, shadow RAM)
- emu_io.h - Platform abstraction for I/O (CLI vs WASM)

ARCHITECTURE PATTERN (romwbw_emu):
  class AltairEmulator : public HBIOSCPUDelegate {
    hbios_cpu* cpu;           // Extends qkz80, handles port I/O
    cpm_mem* memory;          // Banked memory
    HBIOSDispatch hbios;      // HBIOS function dispatch

    // HBIOSCPUDelegate interface
    banked_mem* getMemory() override;
    HBIOSDispatch* getHBIOS() override;
    void initializeRamBankIfNeeded(uint8_t bank) override;
    void onHalt() override;
    void onUnimplementedOpcode(uint8_t opcode, uint16_t pc) override;
  };

PORT ASSIGNMENTS (romwbw_emu):
- Port 0x78/0x7C: Bank select (RAM/ROM)
- Port 0xEC: Inter-bank memory copy (BNKCPY)
- Port 0xED: Bank call (BNKCALL)
- Port 0xEE: Signal port
- Port 0xEF: HBIOS dispatch trigger

ANALYSIS FOR MPM2:
------------------
What mpm2 already has (done right):
1. MpmCpu extends qkz80 with port_in/port_out overrides
2. Port-based XIOS dispatch via port 0xE0
3. BankedMemory class for MP/M II process banks

What mpm2 should adopt:
1. Rebuild against updated qkz80 library (done, just need rebuild)
2. Consider delegate pattern (XIOSCPUDelegate) for cleaner separation
3. Consider emu_io.h abstraction for platform-independent I/O

What should stay different:
1. XIOS vs HBIOS - MP/M II uses different function set
2. Bank layout - MP/M II has process banks (0-N), not ROM/RAM banks
3. Multi-console support via SSH (not in romwbw_emu)

RECOMMENDED CHANGES:
--------------------
1. [MINIMAL] Rebuild against updated cpmemu/src/libqkz80.a
   - Confirms MpmCpu port_in/port_out overrides work with new base class
   - No code changes needed, just rebuild

2. [OPTIONAL] Add halt() override to MpmCpu
   - Currently uses base class default (infinite loop)
   - Could add proper error handling/reporting

3. [OPTIONAL] Add unimplemented_opcode() override to MpmCpu
   - Better diagnostics for invalid Z80 instructions

4. [FUTURE] Consider emu_io.h adoption
   - Would help if we want WASM/iOS builds
   - Current console.h works fine for SSH/terminal

CHANGES MADE (2025-12-23):
--------------------------
1. Rebuilt against updated cpmemu/src/libqkz80.a
   - Now uses qkz80 with virtual port_in/port_out/halt/unimplemented_opcode

2. Added halt() override to MpmCpu (mpm_cpu.h, mpm_cpu.cpp)
   - Prints diagnostic info when HALT instruction encountered
   - Sets halted_ flag for main loop to check

3. Added unimplemented_opcode() override to MpmCpu
   - Prints opcode, PC, registers, and memory context
   - Helps debug invalid instruction execution

4. Added is_halted()/clear_halted() methods to MpmCpu
   - Allows Z80 thread to detect and handle halt conditions

Session: 2025-12-21 (Updated)

PORT-BASED XIOS DISPATCH
------------------------
Replaced PC-based XIOS interception with I/O port dispatch (port 0xE0).
This matches the approach used in romwbw_emu and is cleaner than PC trapping.

Protocol:
- Port 0xE0: XIOS dispatch (A = function offset, other regs as per XIOS spec)
- Port 0xE1: Bank select (A = bank number)
- For SETTRK/SETSEC/SETDMA/SECTRAN: BC is copied to HL before OUT
  because BC contains the parameter and we need A for function code

New Files:
- asm/xios_port.asm - XIOS with OUT (0xE0), A dispatch, ORG at 0xFC00
- asm/ldrbios_port.asm - LDRBIOS with port dispatch, own DPH/DPB
- include/mpm_cpu.h - MpmCpu class extending qkz80 with port handling
- src/mpm_cpu.cpp - Port dispatch implementation

Modified Files:
- src/xios.cpp - handle_port_dispatch(), skip_ret_ flag, HL-based params
- src/z80_thread.cpp - Removed PC interception, uses MpmCpu
- include/xios.h - Added handle_port_dispatch(), skip_ret_ member

LDRBIOS Changes:
- SELDSK returns own DPH (not emulator's) to avoid address conflicts
- SECTRAN returns physical=logical (no translation for 8" SSSD)
- DPB updated for 8" SSSD format (SPT=26, BSH=3, DSM=242, etc.)

CURRENT STATUS
--------------
Boot progress with port-based dispatch:
- MPMLDR starts and displays banner: "MP/M II V2.1 Loader"
- Copyright message shown
- Memory Segment Table displayed (SYSTEM DAT E500H, TMPD DAT AB00H, etc.)
- Disk reads succeed with correct track/sector numbers
- Track numbers now reasonable (69-70) vs previous garbage (46536)
- Still fails: "MPMLDR error: failed to read MPM.SYS"

REMAINING ISSUE
---------------
MPMLDR reads up to track 69-70 for a 25KB file (should only need ~10 tracks).
Track 69 = 0x45 = 'E' which matches "E500H" from Memory Segment Table.
Suspect mismatch between MPMLDR's address calculation and file layout.

PREVIOUS SESSION NOTES
----------------------
(From earlier debugging session)

COMPLETED:
- Fixed double character console output issue in xios.cpp do_conout()
- Fixed sector translation in disk.cpp - cpmtools images store sectors
  in logical order, no skew translation needed
- Identified root cause of "MPMLDR error: failed to read MPM.SYS"

PREVIOUS ISSUE:
- nmb$records in MPM.SYS header (bytes 120-121) was 198 (0x00C6)
- But file is 25600 bytes = 200 records
- MPMLDR loop reads based on nmb$records, causing premature EOF
- Patched header to 200 (0x00C8) - needs testing

NEXT STEPS
----------
1. Check MPM.SYS file format - may need version matching emulator config
2. Trace MPMLDR's block-to-track calculation
3. Verify SYSTEM.DAT configuration matches emulator memory layout
4. Try different MPM.SYS versions from disks/ directory
5. Test with patched nmb$records = 200

BUILD ARTIFACTS
---------------
- Boot image: build/boot_port.img (also in disks/)
- Assembled: asm/xios_port.bin, asm/ldrbios_port.bin
